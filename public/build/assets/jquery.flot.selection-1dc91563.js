(function(u){function P(i){var t={first:{x:-1,y:-1},second:{x:-1,y:-1},show:!1,active:!1},f={},l=null;function v(e){t.active&&(M(e),i.getPlaceholder().trigger("plotselecting",[m()]))}function x(e){e.which==1&&(document.body.focus(),document.onselectstart!==void 0&&f.onselectstart==null&&(f.onselectstart=document.onselectstart,document.onselectstart=function(){return!1}),document.ondrag!==void 0&&f.ondrag==null&&(f.ondrag=document.ondrag,document.ondrag=function(){return!1}),S(t.first,e),t.active=!0,l=function(n){k(n)},u(document).one("mouseup",l))}function k(e){return l=null,document.onselectstart!==void 0&&(document.onselectstart=f.onselectstart),document.ondrag!==void 0&&(document.ondrag=f.ondrag),t.active=!1,M(e),d()?y():(i.getPlaceholder().trigger("plotunselected",[]),i.getPlaceholder().trigger("plotselecting",[null])),!1}function m(){if(!d()||!t.show)return null;var e={},n=t.first,o=t.second;return u.each(i.getAxes(),function(r,s){if(s.used){var c=s.c2p(n[s.direction]),a=s.c2p(o[s.direction]);e[r]={from:Math.min(c,a),to:Math.max(c,a)}}}),e}function y(){var e=m();i.getPlaceholder().trigger("plotselected",[e]),e.xaxis&&e.yaxis&&i.getPlaceholder().trigger("selected",[{x1:e.xaxis.from,y1:e.yaxis.from,x2:e.xaxis.to,y2:e.yaxis.to}])}function w(e,n,o){return n<e?e:n>o?o:n}function S(e,n){var o=i.getOptions(),r=i.getPlaceholder().offset(),s=i.getPlotOffset();e.x=w(0,n.pageX-r.left-s.left,i.width()),e.y=w(0,n.pageY-r.top-s.top,i.height()),o.selection.mode=="y"&&(e.x=e==t.first?0:i.width()),o.selection.mode=="x"&&(e.y=e==t.first?0:i.height())}function M(e){e.pageX!=null&&(S(t.second,e),d()?(t.show=!0,i.triggerRedrawOverlay()):O(!0))}function O(e){t.show&&(t.show=!1,i.triggerRedrawOverlay(),e||i.getPlaceholder().trigger("plotunselected",[]))}function b(e,n){var o,r,s,c,a=i.getAxes();for(var g in a)if(o=a[g],o.direction==n&&(c=n+o.n+"axis",!e[c]&&o.n==1&&(c=n+"axis"),e[c])){r=e[c].from,s=e[c].to;break}if(e[c]||(o=n=="x"?i.getXAxes()[0]:i.getYAxes()[0],r=e[n+"1"],s=e[n+"2"]),r!=null&&s!=null&&r>s){var h=r;r=s,s=h}return{from:r,to:s,axis:o}}function R(e,n){var o,r=i.getOptions();r.selection.mode=="y"?(t.first.x=0,t.second.x=i.width()):(o=b(e,"x"),t.first.x=o.axis.p2c(o.from),t.second.x=o.axis.p2c(o.to)),r.selection.mode=="x"?(t.first.y=0,t.second.y=i.height()):(o=b(e,"y"),t.first.y=o.axis.p2c(o.from),t.second.y=o.axis.p2c(o.to)),t.show=!0,i.triggerRedrawOverlay(),!n&&d()&&y()}function d(){var e=i.getOptions().selection.minSize;return Math.abs(t.second.x-t.first.x)>=e&&Math.abs(t.second.y-t.first.y)>=e}i.clearSelection=O,i.setSelection=R,i.getSelection=m,i.hooks.bindEvents.push(function(e,n){var o=e.getOptions();o.selection.mode!=null&&(n.mousemove(v),n.mousedown(x))}),i.hooks.drawOverlay.push(function(e,n){if(t.show&&d()){var o=e.getPlotOffset(),r=e.getOptions();n.save(),n.translate(o.left,o.top);var s=u.color.parse(r.selection.color);n.strokeStyle=s.scale("a",.8).toString(),n.lineWidth=1,n.lineJoin=r.selection.shape,n.fillStyle=s.scale("a",.4).toString();var c=Math.min(t.first.x,t.second.x)+.5,a=Math.min(t.first.y,t.second.y)+.5,g=Math.abs(t.second.x-t.first.x)-1,h=Math.abs(t.second.y-t.first.y)-1;n.fillRect(c,a,g,h),n.strokeRect(c,a,g,h),n.restore()}}),i.hooks.shutdown.push(function(e,n){n.unbind("mousemove",v),n.unbind("mousedown",x),l&&u(document).unbind("mouseup",l)})}u.plot.plugins.push({init:P,options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})})(jQuery);
